# Кластер PostgreSQL с Patroni, etcd и HAProxy

Проект настраивает кластер PostgreSQL с высокой доступностью, используя Patroni для автоматического переключения узлов, etcd в качестве распределенного хранилища, и HAProxy для балансировки нагрузки между узлами кластера.

## Описание проекта

Кластер PostgreSQL включает следующие компоненты:
- **Patroni**: Управляет экземплярами PostgreSQL и автоматизирует переключение узлов в случае отказа.
- **etcd**: Обеспечивает распределенный консенсус и хранит состояние кластера для Patroni.
- **HAProxy**: Направляет трафик на соответствующий ведущий узел для операций записи и на реплики для операций чтения.
- **PostgreSQL**: Движок базы данных, настроенный на высокую доступность с репликацией, переключением узлов и резервным копированием.

### Краткое руководство по запуску

1. **Клонируйте репозиторий**:

    ```bash
    git clone <repository-url>
    cd <repository-folder>
    ```

2. **Настройте переменные окружения**:

    Создайте файл `.env` в корневой папке проекта со следующими переменными:

    ```bash
    POSTGRES_USER='edw_admin_user'
    POSTGRES_PASSWORD='edw_admin_user'
    POSTGRES_DB='picasso_dwh_storage'
    REPL_POSTGRES_USER='replicator'
    REPL_POSTGRES_PASSWORD='replicator'
    PATRONI_ETCD3_HOSTS='etcd0:2379'
    PATRONI_HTTP_ADMIN='admin'
    PATRONI_HTTP_PASSWORD='admin'
    ETCD_INITIAL_CLUSTER='etcd0=http://etcd0:2380'
    ```

    Настройте переменные в соответствии с вашей средой.

3. **Соберите и запустите сервисы**:

    Выполните следующую команду для запуска всех сервисов с использованием Docker Compose:

    ```bash
    docker build . -f Dockerfile --pull --tag picasso/pg15-patroni:develop
    ```

    Эта команда соберет контейнеры Patroni, после чего можно запускать кластер:

    ```bash
    docker-compose up -d
    ```
    Эта команда запустит узлы etcd, HAProxy и PostgreSQL.

4. **Доступ к статистике HAProxy**:

    HAProxy предоставляет страницу статистики на порту `8404`. Вы можете получить к ней доступ, перейдя по адресу `http://localhost:8404/stats` в браузере.

    Стандартные учетные данные:
    - Имя пользователя: `admin`
    - Пароль: `admin`

5. **Подключение к PostgreSQL**:

    После запуска сервисов можно подключиться к ведущему узлу PostgreSQL через HAProxy (порт `6432`):

    ```bash
    psql -h localhost -p 6432 -d postgres -U edw_admin_user -W
    ```

    Для запросов только на чтение используйте порт `6433` (HAProxy будет балансировать между репликами).

## **Сервисы и конфигурация**

### **Конфигурация Patroni**

Patroni настроен для управления кластером PostgreSQL. Ключевые компоненты в `patroni.yml`:

- **etcd**: Обеспечивает распределенное хранилище для состояния кластера.
- **Параметры PostgreSQL**:
  - **max_connections**: 100
  - **wal_level**: logical
  - **max_replication_slots**: 5
  - **shared_buffers**: 2GB

Полная конфигурация указана в файле `patroni.yml`.

### **etcd**

Сервис etcd используется для распределенного консенсуса. Каждый узел PostgreSQL взаимодействует с etcd для определения состояния кластера и того, какой узел является лидером.

- **Порт**: 2379 (клиентский)
- **Порт**: 2380 (коммуникация между узлами)

### **Конфигурация HAProxy**

HAProxy используется для маршрутизации запросов чтения и записи на соответствующий узел PostgreSQL:
- **Порт 6432**: Направляет трафик на запись на лидера.
- **Порт 6433**: Направляет трафик на чтение на одну из реплик.

### **Структура Docker Compose**

- `pgsql15clu01`, `pgsql15clu02`, `pgsql15clu03`: Узлы PostgreSQL, управляемые Patroni.
- `etcd0`: etcd для координации кластера.
- `haproxy`: Балансировщик нагрузки для PostgreSQL.

## **Томa**

Проект использует Docker-тома для сохранения данных:

- **Тома для данных PostgreSQL**:
  - `pg15clu01-data`
  - `pg15clu02-data`
  - `pg15clu03-data`

- **Том для данных etcd**:
  - `etcd-data`

## **Частые проблемы**

- **Ошибка "no pg_hba.conf entry"**:
  Убедитесь, что в настройках `pg_hba.conf` в файле `patroni.yml` разрешены подключения от всех необходимых хостов, включая диапазоны IP-адресов внутри Docker.

- **Не удается подключиться к PostgreSQL**:
  Проверьте логи контейнеров PostgreSQL с помощью команды:

  ```bash
  docker-compose logs -f --tail 500
  ```

- **Ошибка выбора лидера**:
  Убедитесь, что etcd запущен и доступен для всех узлов Patroni. Вы также можете проверить логи контейнера etcd:

  ```bash
  docker-compose logs -f etcd0
  ```
