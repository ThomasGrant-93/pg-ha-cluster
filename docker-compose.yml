x-postgres-common:
  &postgres-common
  image: picasso/pg15-patroni:develop
  env_file:
    - .env
  ports:
    - "5432"
    - "8008"
  environment:
    &postgres-envs
    PATRONI_ETCD3_HOSTS: ${PATRONI_ETCD3_HOSTS}
    PATRONI_SCOPE: pg15cluster
    PATRONI_NAMESPACE: /${PATRONI_SCOPE:-pg15cluster}
  entrypoint: ["/usr/local/bin/entrypoint.sh"]
  logging:
    options:
      max-size: "1m"
      max-file: "5"
  depends_on:
    - etcd
  healthcheck:
    test: [ "CMD", "pg_isready", "-d", "postgres", "-U", "postgres" ]
    interval: 5s
    timeout: 5s
    retries: 5
  restart: on-failure

x-etcd-common:
  &etcd-common
  image: bitnami/etcd:3.5.16
  restart: unless-stopped
  env_file:
      - .env
  logging:
    options:
      max-size: "1m"
      max-file: "5"
  environment:
    &etcd-envs
    ALLOW_NONE_AUTHENTICATION: yes
    ETCD_LISTEN_PEER_URLS: http://0.0.0.0:2380
    ETCD_LISTEN_CLIENT_URLS: http://0.0.0.0:2379
    ETCD_INITIAL_CLUSTER: ${ETCD_INITIAL_CLUSTER}
    ETCD_INITIAL_CLUSTER_TOKEN: etcd-cluster
    ETCD_INITIAL_CLUSTER_STATE: new
  ports:
    - "2379"
    - "2380"

services:
  etcd:
    <<: *etcd-common
    hostname: etcd
    container_name: etcd
    environment:
      <<: *etcd-envs
      ETCD_NAME: etcd
      ETCD_INITIAL_ADVERTISE_PEER_URLS: http://etcd:2380
      ETCD_ADVERTISE_CLIENT_URLS: http://etcd:2379
    volumes:
        - etcd-data:/bitnami/etcd

  haproxy:
    image: haproxy:3.1-alpine3.20
    hostname: haproxy
    container_name: haproxy
    env_file:
        - .env
    ports:
      - "8008:8008"
      - "8001-8003:8001-8003"
      - "8404:8404"
      - "6432:6432"
      - "6433:6433"
    volumes:
      - ./haproxy/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro

  pgsql15node01:
    <<: *postgres-common
    hostname: pgsql15node01
    container_name: postgresql-01
    environment:
      <<: *postgres-envs
      PATRONI_NAME: pgsql15node01
      PATRONI_RESTAPI_LISTEN: postgresql-01:8001
      PATRONI_RESTAPI_CONNECT_ADDRESS: postgresql-01:8001
      PATRONI_POSTGRESQL_LISTEN: 0.0.0.0:5432
      PATRONI_POSTGRESQL_CONNECT_ADDRESS: postgresql-01:5432
    volumes:
      - ./patroni/patroni.yml:/venv/etc/patroni.yml:ro
      - ./pgbouncer/pgbouncer.ini:/etc/pgbouncer/pgbouncer.ini:ro
      - ./pgbouncer/userlist.txt:/etc/pgbouncer/userlist.txt:ro

  pgsql15node02:
    <<: *postgres-common
    container_name: postgresql-02
    hostname: pgsql15node02
    environment:
      <<: *postgres-envs
      PATRONI_NAME: pgsql15node02
      PATRONI_RESTAPI_LISTEN: postgresql-02:8002
      PATRONI_RESTAPI_CONNECT_ADDRESS: postgresql-02:8002
      PATRONI_POSTGRESQL_LISTEN: 0.0.0.0:5432
      PATRONI_POSTGRESQL_CONNECT_ADDRESS: postgresql-02:5432
    volumes:
      - ./patroni/patroni.yml:/venv/etc/patroni.yml:ro
      - ./pgbouncer/pgbouncer.ini:/etc/pgbouncer/pgbouncer.ini:ro
      - ./pgbouncer/userlist.txt:/etc/pgbouncer/userlist.txt:ro

  pgsql15node03:
    <<: *postgres-common
    container_name: postgresql-03
    hostname: pgsql15node03
    environment:
      <<: *postgres-envs
      PATRONI_NAME: pgsql15node03
      PATRONI_RESTAPI_LISTEN: postgresql-03:8003
      PATRONI_RESTAPI_CONNECT_ADDRESS: postgresql-03:8003
      PATRONI_POSTGRESQL_LISTEN: 0.0.0.0:5432
      PATRONI_POSTGRESQL_CONNECT_ADDRESS: postgresql-03:5432
    volumes:
      - ./patroni/patroni.yml:/venv/etc/patroni.yml:ro
      - ./pgbouncer/pgbouncer.ini:/etc/pgbouncer/pgbouncer.ini:ro
      - ./pgbouncer/userlist.txt:/etc/pgbouncer/userlist.txt:ro

volumes:
    etcd-data:
      driver: local
